<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <title>Empty page</title>

    <script>
        $(function() {
            $("#load-recipes").hide();
            $("#selectedTypes").find("option").remove();
            tinymce.init({
                selector:"#cookingSteps",
                menubar: false,
                toolbar: "undo redo | bold italic | cut copy"
            });
            $.ajax({
                url:"/select/types",
                type:"post",
                complete: [
                    function (response) {
                        var answer = $.parseJSON(response.responseText);
                        if (answer.obj != "false") {
                            $.each(answer.obj, function(key, value) {
                                $("#selectedTypes").append($("<option></option>").attr("value",value.typeName).text(value.typeName));
                            });
                        }
                    }
                ]
            });
            var now = new Date();
            var minDate = now.toISOString().substring(0,16);
            $("#publicationDate").attr("min", minDate);
        });
        function createRecipe() {
            var check = true;
            $("#recipeForm input").each(function() {
                $(this).next("span").remove();
                if ($(this).val() == "") {
                    $(this).after("<span>This field is required</span>");
                    $(this).css("border-color","red");
                    check = false;
                } else {
                    $(this).css("border-color","");
                }
            });
            $("#recipeForm textarea").each(function() {
                $(this).next("span").remove();
                if ($(this).val() == "") {
                    $(this).after("<span>This field is required</span>");
                    $(this).css("border-color","red");
                    check = false;
                } else {
                    $(this).css("border-color","");
                }
            });
            $("#recipeForm select").each(function() {
                $(this).next("span").remove();
                if ($(this).val() == "") {
                    $(this).after("<span>This field is required</span>");
                    $(this).css("border-color","red");
                    check = false;
                } else {
                    $(this).css("border-color","");
                }
            });
            $(".tox-tinymce").next("span").remove();
            if (tinymce.get("cookingSteps").getContent() == "") {
                $(".tox-tinymce").after("<span>This field is required</span>");
                $(".tox-tinymce").css("border-color","red");
                check = false;
            }
            var date = formatDate(new Date($("#publicationDate").val()));
            if(date.indexOf("NaN") >= 0) {
                $("#publicationDate").after("<span>Check date format</span>");
                $("#publicationDate").css("border-color","red");
                check = false;
            } else {
                $("#publicationDate").next("span").remove();
                $("#publicationDate").css("border-color","");
                var currDate = new Date();
                /*console.log(currDate);
                console.log(currDate.getUTCDate());
                console.log(currDate.getUTCMonth() + 1);
                console.log(currDate.getUTCFullYear());
                console.log($("#publicationDate").val());
                console.log(date);
                console.log(date.substring(0, 2));
                console.log(date.substring(3, 5));
                console.log(date.substring(6, 10));*/

                //console.log(currDate.getUTCFullYear() > parseInt(date.substring(6, 10), 10));
                if (currDate.getUTCDate() == parseInt(date.substring(0, 2), 10) && currDate.getUTCMonth() + 1 == parseInt(date.substring(3, 5), 10)) {
                    if (currDate.getUTCHours() > parseInt(date.substring(11, 13), 10)) {
                        $("#publicationDate").after("<span>Date can't be less than current</span>");
                        $("#publicationDate").css("border-color","red");
                        console.log(1);
                        check = false;
                    } else if (currDate.getUTCHours() == parseInt(date.substring(11, 13), 10) && currDate.getUTCMinutes() > parseInt(date.substring(14, 16), 10)) {
                        $("#publicationDate").after("<span>Date can't be less than current</span>");
                        $("#publicationDate").css("border-color","red");
                        check = false;
                        console.log(2)
                    } else {
                        $("#publicationDate").next("span").remove();
                        $("#publicationDate").css("border-color","");
                        console.log(3)
                    }
                } else if (currDate.getUTCFullYear() == parseInt(date.substring(6, 10), 10) && currDate.getUTCMonth() + 1 > parseInt(date.substring(3, 5), 10)) {
                    $("#publicationDate").after("<span>Date can't be less than current</span>");
                    $("#publicationDate").css("border-color","red");
                    check = false;
                    console.log(4)
                } else if (currDate.getUTCFullYear() > parseInt(date.substring(6, 10), 10)) {
                    $("#publicationDate").after("<span>Date can't be less than current</span>");
                    $("#publicationDate").css("border-color","red");
                    check = false;
                    console.log(5)
                }
            }
            var data = new FormData();
            $.each($("#file")[0].files, function(i, file) {
                data.append("image", file);
            });
            if (!check || data.get("image") == null) {
                return;
            }
            data.append("recipeName", $("#recipeName").val());
            data.append("recipeComposition", $("#composition").val());
            data.append("cookingSteps", tinymce.get("cookingSteps").getContent());
            var selectedTypes = "";
            $.each($("#selectedTypes").val(), function( index, value ) {
                selectedTypes += value + "/";
            });
            selectedTypes = selectedTypes.slice(0, -1);
            data.append("selectedTypes", selectedTypes);
            data.append("publicationDate", date);
            $.ajax({
                url:"/add/recipe",
                type:"post",
                data: data,
                processData: false,
                contentType: false,
                complete: [
                    function (response) {
                        var answer = $.parseJSON(response.responseText);
                        if (answer.status == true && answer.obj != false) {
                            $("#recipeForm input").next("span").remove();
                            $("#recipeForm textarea").next("span").remove();
                            $("#recipeForm select").next("span").remove();
                            $(".tox-tinymce").next("span").remove();

                            $("#recipeForm input").each(function() {
                                $(this).val("");
                            });
                            $("#recipeForm textarea").each(function() {
                                $(this).val("");
                            });
                            $("#recipeForm select").each(function() {
                                $(this).val([]);
                            });
                            tinymce.get("cookingSteps").setContent("");
                            alert("Recipe successfully added");
                        }  else if (answer.status == true && answer.obj == false && answer.comment != "") {
                            alert(answer.comment);
                        } else {
                            alert("Something went wrong!");
                        }
                    }
                ]
            });
        }
        function formatDate(date) {
            var hours = date.getHours();
            var minutes = date.getMinutes();
            minutes = minutes < 10 ? "0"+minutes : minutes;
            var year = date.getFullYear();
            var month = date.getMonth() + 1;
            month = month < 10 ? "0" + month : month;
            var date = date.getDate();
            date = date < 10 ? "0" + date : date;
            hours = hours < 10  ? "0" + hours : hours;
            minutes = minutes < 10  ? "0" + minutes : minutes;
            var strTime = date + "/" + month + "/" + year + " " + hours + ":" + minutes + ":00";
            return strTime;
        }
    </script>
</head>
<body>
<!-- Page Content -->
<div class="container" id="main-container">
    <div class="row">
        <div class="col-lg-12 text-center">
            <!-- Page Content -->
            <div class="container" id="content-container">
                <div id="recipeForm">
                    <h3>Recipes are approved once a day. If your recipe didnâ€™t appear - it was rejected</h3>
                    <div class="form-group">
                        <label for="recipeName">Name</label>
                        <input type="text" class="form-control" id="recipeName">
                    </div>
                    <div class="form-group">
                        <label for="composition">Ingredients</label>
                        <textarea class="form-control" id="composition" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="cookingSteps">Recipe</label>
                        <div class="form-control" id="cookingSteps"></div>
                    </div>
                    <div class="form-group">
                        <label for="publicationDate">Publication date (if you using Firefox - input date manually in this format: yyyy-mm-ddThh24:mm (for example, 2010-12-22T00:12). <b>Attention: your date must be in UTC timezone</b></label>
                        <input  class="form-control" type="datetime-local" id="publicationDate" placeholder="yyyy-mm-ddThh24:mm" max="2999-12-31T23:59"/>
                    </div>
                    <div class="form-group" id="select-form-group">
                        <label for="selectedTypes">Categories</label>
                        <select multiple class="form-control" id="selectedTypes">
                        </select>
                    </div>
                    <div class="form-group" id="img-form-group">
                        <label for="file">Image</label>
                        <input name="image" type="file" class="form-control" id="file"/>
                    </div>
                    <button class="btn btn-primary" id="submitRecipe" onclick="createRecipe()">Submit</button>
                </div>
            </div>
        </div>
    </div>
</div>
</body>
</html>